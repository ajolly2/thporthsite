<script>
  document.addEventListener('DOMContentLoaded', () => {
    // Helper function to fetch and render an XML feed and attach click event listeners to its links
    function fetchFeed(containerSelector, feedUrl) {
      const container = document.querySelector(containerSelector);
      if (!container) return;
      fetch(feedUrl)
        .then(res => res.text())
        .then(str => {
          const parser = new DOMParser();
          const xml = parser.parseFromString(str, "application/xml");
          const items = Array.from(xml.querySelectorAll('item'));
          if (items.length > 0) {
            const ul = document.createElement("ul");
            items.forEach(item => {
              const title = item.querySelector('title')?.textContent || 'No title';
              const link = item.querySelector('link')?.textContent || '#';
              const li = document.createElement("li");
              const a = document.createElement("a");
              a.href = link;
              a.target = "_blank";
              a.textContent = title;
              li.appendChild(a);
              ul.appendChild(li);
            });
            container.innerHTML = "";
            container.appendChild(ul);
            // Attach event listeners to each link in the newly added feed
            ul.querySelectorAll("a").forEach(link => {
              link.addEventListener("click", () => {
                link.classList.add("clicked");
              });
            });
          } else {
            container.innerHTML = "<p>No items found.</p>";
          }
        })
        .catch(error => {
          console.error("Error loading feed:", error);
          container.innerHTML = "<p>Error loading feed.</p>";
        });
    }
    
    // Fetch feeds for Home panel using feedMap
    const feedMap = {
      ESPN: 'https://www.espn.com/espn/rss/news',
      CBS: 'https://rss.app/feeds/oVrPZDHkkJB8bEKG.xml',
      FOX: 'https://rss.app/feeds/KzC1hdnt93oattSD.xml',
      Yahoo: 'https://rss.app/feeds/3BSRBZ6GJrUbB5PC.xml'
    };
    Object.entries(feedMap).forEach(([key, url]) => {
      fetchFeed(`#feed-${key} .feed-content`, url);
    });
    
    // Fetch custom feeds for existing sections
    fetchFeed('#feed-_6gzCeS4YQ4h2adTs .feed-content', 'https://rss.app/feeds/_6gzCeS4YQ4h2adTs.xml'); // MLB
    fetchFeed('#feed-_ja3fYEA7yigAcmAk .feed-content', 'https://rss.app/feeds/_ja3fYEA7yigAcmAk.xml'); // NBA
    fetchFeed('#feed-_iiyR3EPoC5QXMnqt .feed-content', 'https://rss.app/feeds/_iiyR3EPoC5QXMnqt.xml'); // NFL
    fetchFeed('#feed-_pBOHW7eyjbGkaiZq .feed-content', 'https://rss.app/feeds/_pBOHW7eyjbGkaiZq.xml'); // MLS
    fetchFeed('#feed-PremierLeague .feed-content', 'https://rss.app/feeds/_zvRqo1UuuoLB5czl.xml'); // Premier League
    fetchFeed('#feed-UEFAChampionsLeague .feed-content', 'https://rss.app/feeds/_BnF56qFhfPBsVZ6I.xml'); // UEFA Champions League
    fetchFeed('#feed-SerieA .feed-content', 'https://rss.app/feeds/_IEjWrVaKRW3QNEkB.xml'); // Serie A
    fetchFeed('#feed-Bundesliga .feed-content', 'https://rss.app/feeds/_OFOWQNsn38MFTtLv.xml'); // Bundesliga
    fetchFeed('#feed-LaLiga .feed-content', 'https://rss.app/feeds/_zvRqo1UuuoLB5czl.xml'); // LaLiga
    fetchFeed('#feed-_5c3ZcfSrwvdwdG2Z .feed-content', 'https://rss.app/feeds/_5c3ZcfSrwvdwdG2Z.xml'); // NHL
    
    // Fetch custom feeds for new news sections
    fetchFeed('#feed-Soccer .feed-content', 'https://rss.app/feeds/_X9Xovb703UELx2SR.xml'); // Soccer
    fetchFeed('#feed-FACup .feed-content', 'https://rss.app/feeds/_w1qT9O9DzNOQHCFW.xml'); // FA Cup
    fetchFeed('#feed-LigaMX .feed-content', 'https://rss.app/feeds/_JgpA2OqGGC8IrApe.xml'); // Liga MX
    fetchFeed('#feed-NWSL .feed-content', 'https://rss.app/feeds/_AfGYD33BOZl9OWYz.xml'); // NWSL
    fetchFeed('#feed-Ligue1 .feed-content', 'https://rss.app/feeds/_9nS7hLmB3aUlWcjH.xml'); // Ligue 1
    fetchFeed('#feed-UEFAEuropaLeague .feed-content', 'https://rss.app/feeds/_Op8jopGsYny0gt0e.xml'); // UEFA Europa League
    fetchFeed('#feed-UEFAConferenceLeague .feed-content', 'https://rss.app/feeds/weob7vyzbRkL8od8.xml'); // UEFA Conference League
    fetchFeed('#feed-FormulaOne .feed-content', 'https://rss.app/feeds/_69qKKrngeWZusxVz.xml'); // Formula One
    fetchFeed('#feed-NCAAF .feed-content', 'https://rss.app/feeds/_e8BTSPZYg61J9CYu.xml'); // NCAAF
    fetchFeed('#feed-PGATour .feed-content', 'https://rss.app/feeds/_QQsPX3f8GnzYvAXX.xml'); // PGA Tour
    
    // Existing menu functionality
    let selectedSection = 'Home';
    document.querySelectorAll('.menu-filter').forEach(filter => {
      filter.addEventListener('click', () => {
        document.getElementById('menuSearch').value = '';
        ['123', 'az', 'group'].forEach(type => {
          document.querySelectorAll('#menuList-' + type + ' li').forEach(li => {
            li.style.display = '';
          });
        });
        document.querySelectorAll('.menu-filter').forEach(f => f.classList.remove('active'));
        filter.classList.add('active');
        const type = filter.dataset.filter;
        document.getElementById('menuList-123').style.display = (type === '123') ? 'block' : 'none';
        document.getElementById('menuList-az').style.display = (type === 'az') ? 'block' : 'none';
        document.getElementById('menuList-group').style.display = (type === 'group') ? 'block' : 'none';
        const newList = document.getElementById('menuList-' + type);
        if (newList) {
          newList.querySelectorAll('li[data-section]').forEach(li => {
            li.classList.toggle('selected', li.dataset.section === selectedSection);
          });
        }
      });
    });
    
    document.querySelectorAll('#menuList li').forEach(item => {
      item.addEventListener('click', e => {
        if (item.classList.contains('spacer-line') || item.classList.contains('soccer-more-toggle')) {
          e.stopPropagation();
          return;
        }
        e.stopPropagation();
        if (item.dataset.section) {
          selectedSection = item.dataset.section;
        }
        document.querySelectorAll('#menuList li[data-section]').forEach(li => li.classList.remove('selected'));
        item.classList.add('selected');
        const section = item.dataset.section;
        document.querySelectorAll('.news .content-section').forEach(s => s.style.display = 'none');
        document.querySelectorAll('.social .content-section').forEach(s => s.style.display = 'none');
        const news = document.getElementById('news-' + section);
        const social = document.getElementById('social-' + section);
        if (news) {
          news.style.display = 'block';
          if (section === 'Home') {
            document.getElementById('newsSubMenu').style.display = 'flex';
            const container = document.querySelector('.news');
            container.scrollTop = 0;
            container.dispatchEvent(new Event('scroll'));
          } else {
            document.getElementById('newsSubMenu').style.display = 'none';
          }
        }
        if (social) social.style.display = 'block';
      });
    });
    
    const feeds = ['feed-ESPN', 'feed-CBS', 'feed-FOX', 'feed-Yahoo'];
    const newsPanel = document.querySelector('.news');
    newsPanel.addEventListener('scroll', () => {
      const top = newsPanel.getBoundingClientRect().top;
      const offset = document.getElementById('newsSubMenu').offsetHeight + 50;
      let active = 0;
      for (let i = 0; i < feeds.length; i++) {
        const el = document.getElementById(feeds[i]);
        if (!el) continue;
        const h4 = el.querySelector('h4');
        if (!h4) continue;
        if (h4.getBoundingClientRect().top > top + offset) break;
        active = i;
      }
      const feedName = feeds[active].replace('feed-', '').toLowerCase();
      document.querySelectorAll('.news-menu-item').forEach(item => {
        item.classList.toggle('active', item.dataset.feed.toLowerCase() === feedName);
      });
    });
    
    document.getElementById('menuSearch').addEventListener('keyup', function () {
      const query = this.value.toLowerCase();
      const activeFilterElem = document.querySelector('.menu-filter.active');
      if (!activeFilterElem) return;
      const activeFilter = activeFilterElem.dataset.filter;
      const activeList = document.getElementById('menuList-' + activeFilter);
      if (activeList) {
        activeList.querySelectorAll('li').forEach(li => {
          li.style.display = li.textContent.toLowerCase().includes(query) ? '' : 'none';
        });
      }
    });
    
    window.toggleSoccerMore = function() {
      const section = document.getElementById('soccer-more');
      const toggle = document.querySelector('.soccer-more-toggle');
      const expanded = section.style.display === 'block';
      section.style.display = expanded ? 'none' : 'block';
      toggle.textContent = expanded ? 'More…' : 'Less…';
    };
    
    // For any RSS feed links that might have been added outside fetchFeed, force them to open in a new tab and attach click listener
    document.querySelectorAll(".rss-feed a").forEach(link => {
      link.setAttribute("target", "_blank");
      link.addEventListener("click", () => {
        link.classList.add("clicked");
      });
    });
  });
</script>
